# -*- coding: utf-8 -*-
import os, smtplib, logging, random
from datetime import datetime
from flask import Flask, request, jsonify
from flask_cors import CORS
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import openai
import base64
from io import BytesIO
import matplotlib.pyplot as plt

# === Setup ===
app = Flask(__name__)
CORS(app)
app.logger.setLevel(logging.DEBUG)

openai.api_key = os.getenv("OPENAI_API_KEY")

SMTP_SERVER = "smtp.gmail.com"
SMTP_PORT = 587
SMTP_USERNAME = "kata.chatbot@gmail.com"
SMTP_PASSWORD = os.getenv("SMTP_PASSWORD")

# === Chinese Mappings ===
CHINESE_MONTHS = {
    'ä¸€æœˆ': 1, 'äºŒæœˆ': 2, 'ä¸‰æœˆ': 3, 'å››æœˆ': 4,
    'äº”æœˆ': 5, 'å…­æœˆ': 6, 'ä¸ƒæœˆ': 7, 'å…«æœˆ': 8,
    'ä¹æœˆ': 9, 'åæœˆ': 10, 'åä¸€æœˆ': 11, 'åäºŒæœˆ': 12
}
CHINESE_GENDER = {
    'ç”·': 'male',
    'å¥³': 'female'
}

# === Helper: Age Calculation ===
def compute_age(data):
    day = data.get("dob_day")
    month_str = str(data.get("dob_month")).strip()
    year = data.get("dob_year")

    if not (day and month_str and year):
        return None

    # Detect month (digit, zh, en)
    if month_str.isdigit():
        month = int(month_str)
    elif month_str in CHINESE_MONTHS:
        month = CHINESE_MONTHS[month_str]
    else:
        try:
            month = datetime.strptime(month_str, "%B").month  # 'March'
        except:
            raise ValueError(f"time data '{month_str}' does not match format '%B'")

    dob = datetime(int(year), int(month), int(day))
    today = datetime.now()
    return today.year - dob.year - ((today.month, today.day) < (dob.month, dob.day))

# === Helper: Chart Generator ===
def generate_chart(title, labels, values):
    fig, ax = plt.subplots(figsize=(5, 2.5))
    ax.bar(labels, values, color=['#5E9CA0', '#FF9F40', '#9966FF'])
    ax.set_title(title)
    ax.set_ylim(0, 100)
    plt.tight_layout()
    buf = BytesIO()
    plt.savefig(buf, format='png')
    plt.close(fig)
    return base64.b64encode(buf.getvalue()).decode()

# === Route ===
@app.route("/analyze_name", methods=["POST"])
def analyze_name():
    data = request.json

    try:
        name = data.get("name", "").strip()
        chinese_name = data.get("chinese_name", "").strip()
        gender_raw = data.get("gender", "")
        gender = CHINESE_GENDER.get(gender_raw, gender_raw.lower())
        age = compute_age(data)
        country = data.get("country", "Singapore").strip()
        email = data.get("email", "").strip()

        # Fake data for simulation
        learning_styles = [random.randint(50, 80), random.randint(20, 40), random.randint(10, 30)]
        study_habits = [random.randint(40, 70), random.randint(20, 50), random.randint(30, 60)]
        confidence = [random.randint(50, 90), random.randint(40, 70), random.randint(30, 60)]

        metrics = [
            {"title": "å­¦ä¹ é£æ ¼", "labels": ["è§†è§‰å‹", "å¬è§‰å‹", "åŠ¨æ‰‹å‹"], "values": learning_styles},
            {"title": "å­¦ä¹ æŠ•å…¥", "labels": ["æ¯æ—¥å¤ä¹ ", "å°ç»„å­¦ä¹ ", "ç‹¬ç«‹å­¦ä¹ "], "values": study_habits},
            {"title": "å­¦ä¹ ä¿¡å¿ƒ", "labels": ["æ•°å­¦", "é˜…è¯»", "ä¸“æ³¨åŠ›"], "values": confidence}
        ]

        charts_html = ""
        for m in metrics:
            img = generate_chart(m["title"], m["labels"], m["values"])
            charts_html += f"<h4>{m['title']}</h4><img src='data:image/png;base64,{img}' style='max-width:100%;'><br><br>"

        # ğŸ§  AI Summary (Chinese, Deep Style)
        analysis_prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹æ•°æ®ç”Ÿæˆä¸€ä»½è¯¦ç»†çš„å„¿ç«¥å­¦ä¹ åˆ†ææ€»ç»“ï¼Œè¯­æ°”æ¸©æš–è€Œæ·±å…¥ï¼Œé€‚åˆå®¶é•¿é˜…è¯»ï¼š

å›½å®¶ï¼š{country}
å¹´é¾„ï¼š{age}å²
æ€§åˆ«ï¼š{gender_raw}
è§†è§‰å‹ï¼š{learning_styles[0]}%
å¬è§‰å‹ï¼š{learning_styles[1]}%
åŠ¨æ‰‹å‹ï¼š{learning_styles[2]}%
æ¯æ—¥å¤ä¹ ï¼š{study_habits[0]}%
å°ç»„å­¦ä¹ ï¼š{study_habits[1]}%
ç‹¬ç«‹å­¦ä¹ ï¼š{study_habits[2]}%
æ•°å­¦ä¿¡å¿ƒï¼š{confidence[0]}%
é˜…è¯»ä¿¡å¿ƒï¼š{confidence[1]}%
ä¸“æ³¨åŠ›ä¿¡å¿ƒï¼š{confidence[2]}%

è¯·åˆ†æˆ 4 æ®µæ–‡å­—ï¼Œæ¯æ®µçº¦ 3â€“5 è¡Œï¼Œå›´ç»•å­©å­çš„å­¦ä¹ åå¥½ã€æŠ•å…¥æ–¹å¼ã€è‡ªä¿¡å¿ƒè¡¨ç°ä»¥åŠå®¶é•¿å¯æä¾›çš„æ”¯æŒã€‚"""

        ai_response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=[{"role": "user", "content": analysis_prompt}],
            temperature=0.7
        )
        analysis = ai_response.choices[0].message.content.strip()

        # === Email Report ===
        email_body = f"""
        <html>
        <body>
        <h2>ğŸ“ å­©å­å­¦ä¹ åˆ†ææŠ¥å‘Š</h2>
        <p><strong>å§“åï¼š</strong>{name}ï¼ˆ{chinese_name}ï¼‰<br>
        <strong>å¹´é¾„ï¼š</strong>{age} å²<br>
        <strong>å›½å®¶ï¼š</strong>{country}<br>
        <strong>æ€§åˆ«ï¼š</strong>{gender_raw}</p>
        {charts_html}
        <div style="margin-top:20px; line-height:1.6; font-size:16px;">{analysis}</div>
        <hr><p><strong>Insights generated by KataChatBot AI.</strong><br>ğŸ“§ kata.chatbot@gmail.com</p>
        </body>
        </html>
        """
        send_email(email_body)

        return jsonify({
            "metrics": metrics,
            "analysis": analysis
        })

    except Exception as e:
        return jsonify({"error": f"{str(e)}"}), 400

# === Email Sender ===
def send_email(html_body):
    msg = MIMEMultipart('alternative')
    msg['Subject'] = "æ–°çš„ KataChatBot æäº¤è®°å½•"
    msg['From'] = SMTP_USERNAME
    msg['To'] = SMTP_USERNAME
    msg.attach(MIMEText(html_body, 'html', 'utf-8'))
    with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
        server.starttls()
        server.login(SMTP_USERNAME, SMTP_PASSWORD)
        server.send_message(msg)
